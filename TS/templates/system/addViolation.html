{% extends "ts_index.html" %}

{% block content %}
<section id="add-violation-content">
  <div class="section-header mb-4">
    <div class="title-section">
      <i class="fas fa-plus-circle icon"></i><b> VIOLATION TICKET</b>
    </div>
  </div>

  <div class="container-fluid">
    <form id="add-violation-form">
      {% csrf_token %}

      <!-- Ticket Number -->
      <div class="row mb-3">
        <div class="col-12 d-flex align-items-center ps-4">
          <h2 class="me-3 mb-0"><b>Ticket #{{ ticket_id }}</b></h2>
          <input type="hidden" id="ticket_id" name="ticket_id" value="{{ ticket_id }}">
        </div>
      </div>

      <div class="row g-3">


        <!-- Violation Type, Photo, Description -->
        <div class="col-md-3">
          <div class="violations-details p-3">
            <p><b>Violation Type:</b></p>
            <div><input type="checkbox" name="violation_types" value="id_violation"> ID Violation</div>
            <div><input type="checkbox" name="violation_types" value="dress_code_violation"> Dress Code Violation</div>
            <div><input type="checkbox" name="violation_types" value="uniform_violation"> Uniform Violation</div>

            <label for="photo-proof" class="mt-3"><b>Photo Proof:</b></label>
            <input type="file" id="photo-proof" name="photo" capture="proof" accept="image/*" class="form-control mb-3">

            <label for="description"><b>Description:</b></label>
            <input type="text" id="description" name="description" class="form-control">
          </div>
        </div>

        <!-- Divider -->
        <div class="col-md-1 d-flex justify-content-center align-items-center">
          <div style="border-left: 1px solid #ccc; height: 100%;"></div>
        </div>

        <!-- Student Photo + Details -->
        <div class="col-md-3">
          <div class="student-photo text-center">
            <h4><b>Student Details</b></h4>
            <!-- Add photo display here if available -->
          </div>
        </div>

        <div class="col-md-3">
          <div class="student-details mt-2 p-3">
            <label for="student-name"><b>Name:</b></label>
            <input type="text" id="student-name" name="student_name" class="form-control mb-2" placeholder="Student Full Name">

            <label for="student-id"><b>Student ID:</b></label>
            <input type="numeric" id="student-id" name="student_id" class="form-control mb-3" placeholder="Student No.">

            <div class="d-flex justify-content-end">
              <a href="{% url 'ts:Dashboard' %}" class="btn btn-outline-danger cancel-btn mt-5 me-2">CANCEL</a>
              <button type="submit" class="btn btn-primary confirm-btn mt-5">CONFIRM</button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</section>
<script>
  const form = document.getElementById("add-violation-form");
  form.addEventListener("submit", function (e) {
    e.preventDefault();

    const formData = new FormData(form);
    const selected = formData.getAll("violation_types");
    const ticketId = formData.get('ticket_id');
    const remarks = formData.get("description");
    const student = formData.get("student_id");
    
    if (selected.length === 0) {
        alert("Please select at least one violation type.");
        return;
    }

    fetch("/admin/xu-entry-violation/create-ticket", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({
            ticket_id: ticketId,
            violations: selected,
            remarks: remarks,
            student_id: student
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Ticket #{{ ticket_id }} Submitted!"); window.location.href="{% url 'ts:Dashboard' %}";
        } else {
            alert("Error submitting the ticket.");
        }
    })
    .catch(err => {
        console.error("AJAX error:", err);
        alert("Request failed.");
    });
});
function getCSRFToken() {
  // Django CSRF token is usually stored in a cookie named csrftoken
  return document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1] || '';
}
</script>
{% endblock %}
