{% extends "tsp_index.html" %}

{% block content %}
<section id="add-violation-content">
  <div class="section-header mb-4">
    <div class="title-section">
      <i class="fas fa-plus-circle icon"></i><b> VIOLATION TICKET</b>
    </div>
  </div>

  <div class="container-fluid">
    <form id="add-violation-form">
      {% csrf_token %}

      <!-- Ticket Number -->
      <div class="row mb-3">
        <div class="col-12 d-flex align-items-center ps-4">
          <h2 class="me-3 mb-0"><b>Ticket #{{ ticket_id }}</b></h2>
          <input type="hidden" id="ticket_id" name="ticket_id" value="{{ ticket_id }}">
        </div>
      </div>

      <div class="row g-3">


        <!-- Violation Type, Photo, Description -->
        <div class="col-md-3">
          <div class="violations-details p-3">
            <p><b>Violation Type:</b></p>
            <div><input type="checkbox" name="violation_types" id="violation_types" value="id_violation"> ID Violation</div>
            <div><input type="checkbox" name="violation_types" id="violation_types" value="dress_code_violation"> Dress Code Violation</div>
            <div><input type="checkbox" name="violation_types" id="violation_types" value="uniform_violation"> Uniform Violation</div>

            <label for="photo-proof" class="mt-3"><b>Photo Proof:</b></label>
            <input type="file" id="photo-proof" name="photo" capture="proof" accept="image/*" class="form-control mb-3">

            <label for="description"><b>Description:</b></label>
            <input type="text" id="description" name="description" class="form-control">
          </div>
        </div>

        <!-- Divider -->
        <div class="col-md-1 d-flex justify-content-center align-items-center">
          <div style="border-left: 1px solid #ccc; height: 100%;"></div>
        </div>

        <!-- Student Photo + Details -->
        <div class="col-md-3">
          <div class="student-photo text-center">
            <h4><b>Student Details</b></h4>
            <!-- Add photo display here if available -->
          </div>
        </div>

        <div class="col-md-3">
          <div class="student-details mt-2 p-3">
            <label for="student-name"><b>First Name:</b></label>
            <input type="text" id="student-first-name" name="student-first-name" class="form-control" placeholder="Student First Name">
            <label for="student-name"><b>Middle Name:</b></label>
            <input type="text" id="student-middle-name" name="student-middle-name" class="form-control" placeholder="Student Middle Name">
            <label for="student-name"><b>Last Name:</b></label>
            <input type="text" id="student-last-name" name="student-last-name" class="form-control mb-2" placeholder="Student Last Name">

            <label for="student-id"><b>Student ID:</b></label>
            <input type="numeric" id="student-id" name="student_id" class="form-control mb-3" placeholder="Student No.">

            <div class="d-flex justify-content-end">
              <a href="{% url 'ts.personel:Dashboard' %}" class="btn btn-outline-danger cancel-btn mt-5 me-2">CANCEL</a>
              <button type="submit" class="btn btn-primary confirm-btn mt-5">CONFIRM</button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</section>
<script>
  const form = document.getElementById("add-violation-form");
form.addEventListener("submit", function (e) {
  e.preventDefault();

  const formData = new FormData(form);
  const selected = formData.getAll("violation_types");
  const remarks = formData.get("description");
  const ticketId = formData.get("ticket_id");
  const student_id = formData.get("student_id");
  const fname = formData.get("student-first-name");
  const mname = formData.get("student-middle-name");
  const lname = formData.get("student-last-name");

  if (!ticketId || !student_id || !fname || !lname) {
    alert("Please fill in all required fields.");
    return;
  }

  if (selected.length === 0) {
    alert("Please select at least one violation type.");
    return;
  }

  fetch("/personel/xu-entry-violation/create-ticket", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify({
        ticket_id: parseInt(ticketId, 10),
        violations: selected,
        remarks: remarks,
        student_id: student_id,
        fname: fname,
        mname: mname,
        lname: lname
      }),
    })
    .then(data => { 
    if (data.success) 
    {} 
    else 
    {
      get_ticket_data(`${ticketId}`)
    }
  })
  .catch(err => {
    alert("Error: " + err.message);
  });
});

function get_ticket_data(ticketId) {
  fetch(`/ts/dev/api/${ticketId}/get-ticket`, {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCSRFToken() // optional for GET, but safe to include
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error("Failed to fetch ticket data");
    }
    return response.json();
  })
  .then(data => {
    const ticket = data.ticket;
    const student = data.student;
    send_ticket(ticket, student)
  })
  .catch(error => {
    console.error("Error fetching ticket data:", error);
    alert("Could not fetch ticket data.");
  });
}
    
function send_ticket(ticket, student){
  fetch(`http://localhost:8001/evs/dev/api/ticket-submission`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      ticket: ticket,
      student: student
    })
  })
  .then(response => {
    if (response.ok)
    {
      alert('Ticket Submitted Successfully.');
      location.reload();
    }
  })
  .catch(error => {
    console.error("Failed to submit ticket to OSA", error);
    alert("Could not fetch ticket data.");
  });
}

function getCSRFToken() {
  return document.cookie
    .split(";")
    .find(c => c.trim().startsWith("csrftoken="))
    ?.split("=")[1] || "";
}
</script>
{% endblock %}

